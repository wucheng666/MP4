<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <script src="./parseISOFile.js"></script>
  </head>
  <body>
    <video controls></video>
    <div>
      <h3>Business Data:</h3>
      <span id="business"></span>
    </div>
  </body>
  <script>
    window.onload = () => {
      var video = document.querySelector('video')
      var business = document.querySelector('#business')
      var assetURL = 'https://wucheng666.github.io/MP4/parseBusinessData/setJsonOutFrag.mp4'

      var iSOFile = parseISOFile(processParsedDataCallBack)

      function fetchRange(url, start, end, cb) {
        var xhr = new XMLHttpRequest()
        xhr.open('get', url)
        xhr.responseType = 'arraybuffer'
        xhr.setRequestHeader('Range', 'bytes=' + start + '-' + end)
        xhr.onload = function() {
          console.log('fetched bytes: ', start, end)
          cb(xhr.response)
        }
        xhr.send()
      }

      //这里只请求一次，默认已知2M数据会含有完整的moov信息，如果没有得到完整的数据，则还是要继续请求数据的（这里没有考虑这些）
      fetchRange(assetURL, 0, 2 * 1024 * 1024, fetchCallBack)

      function fetchCallBack(buffer) {
        buffer.fileStart = 0
        iSOFile.appendBuffer(buffer)
      }

      function processParsedDataCallBack({ boxInfo = {}, arrayBuffer, error = {} }) {
        if ('moov' === boxInfo.type) {
          //解析自定义数据
          if (
            boxInfo.box &&
            boxInfo.box.traks[0] &&
            boxInfo.box.traks[0].meta &&
            boxInfo.box.traks[0].meta['xml ']
          ) {
            let businessData = JSON.parse(
              String.fromCodePoint
                .apply(null, boxInfo.box.traks[0].meta['xml '].data)
                .replaceAll('\u0000', '')
            )
            business.innerHTML = businessData
            console.log('====businessData:', businessData)
          }
        }
      }
    }
  </script>
</html>
